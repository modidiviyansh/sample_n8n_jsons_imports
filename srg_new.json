{
  "name": "School Report - Native AI with Retry",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "school-report-generate",
        "responseMode": "responseNode"
      },
      "id": "node-webhook",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 600]
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.item.json;\nconst body = inputData.body || inputData;\n\nconst formResponses = body.form_responses || [];\nconst schoolName = formResponses.find(q => q.question_number === 1)?.response || \"Unknown School\";\nconst fees = formResponses.find(q => q.question_number === 2)?.response_label || \"Not provided\";\nconst travelTime = formResponses.find(q => q.question_number === 3)?.response || \"Not provided\";\nconst activities = formResponses.find(q => q.question_number === 4)?.selected_activities || [];\nconst hasAC = formResponses.find(q => q.question_number === 5)?.response || \"No\";\nconst classExcitement = formResponses.find(q => q.question_number === 6)?.response || 5;\nconst learningEnv = formResponses.find(q => q.question_number === 7)?.response || 5;\n\nconst categories = [\n  { name: \"Teaching Quality\", our: body.our_score1 || 0, gcm: body.other_score1 || 0, difference: (body.our_score1 || 0) - (body.other_score1 || 0) },\n  { name: \"Facilities\", our: body.our_score2 || 0, gcm: body.other_score2 || 0, difference: (body.our_score2 || 0) - (body.other_score2 || 0) },\n  { name: \"Activities\", our: body.our_score3 || 0, gcm: body.other_score3 || 0, difference: (body.our_score3 || 0) - (body.other_score3 || 0) },\n  { name: \"Environment\", our: body.our_score4 || 0, gcm: body.other_score4 || 0, difference: (body.our_score4 || 0) - (body.other_score4 || 0) },\n  { name: \"Student Support\", our: body.our_score5 || 0, gcm: body.other_score5 || 0, difference: (body.our_score5 || 0) - (body.other_score5 || 0) }\n];\n\nconst categoryText = categories.map(c => `${c.name}: ${c.our}% vs ${c.gcm}% (${c.difference >= 0 ? '+' : ''}${c.difference}%)`).join('\\n');\n\nconst fullContext = `School Comparison Analysis:\n\nCurrent School: ${schoolName}\nCompetitor: GCM Convent School\nBackground: Rural school seeking multi-dimensional excellence\n\nScore Breakdown:\n${categoryText}\n\nOverall: ${schoolName} ${body.overall_score_our || 0}% vs GCM ${body.overall_score_others || 0}%\n\nGrowth Potential:\n- Happiness: +${body.happiness_difference || 0}%\n- Ranking: #${body.ranking_difference || 0}\n- Total Improvement: ${body.total_improvement_difference || 0}%\n\nFamily Context:\n- Fees: ${fees}\n- Travel: ${travelTime}\n- Activities: ${activities.join(', ') || 'Limited'}\n- AC: ${hasAC}\n- Excitement: ${classExcitement}/10\n- Environment: ${learningEnv}/10\n\nKey: Most schools excel in ONE area. GCM excels in ALL dimensions.`;\n\nreturn {\n  timestamp: new Date().toISOString(),\n  school_name: schoolName,\n  comparison_school: body.others_name || \"GCM Convent School\",\n  mobile_number: body.mobile_number,\n  our_school_score: body.overall_score_our || 0,\n  gcm_score: body.overall_score_others || 0,\n  score_difference: (body.overall_score_our || 0) - (body.overall_score_others || 0),\n  categories: categories,\n  categories_text: categoryText,\n  happiness_difference: body.happiness_difference || 0,\n  ranking_improvement: body.ranking_difference || 0,\n  total_improvement: body.total_improvement_difference || 0,\n  fees: fees,\n  travel_time: travelTime,\n  activities: activities.join(\", \"),\n  activities_count: activities.length,\n  has_ac: hasAC,\n  class_excitement: classExcitement,\n  learning_environment: learningEnv,\n  full_context: fullContext,\n  school_type: \"rural\",\n  form_responses: formResponses,\n  retry_count: body.retry_count || 0,\n  max_retries: 3\n};"
      },
      "id": "node-transform",
      "name": "Transform Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 600]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "task_type",
              "value": "executive_summary",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "prompt_text",
              "value": "=You are an empathetic educational consultant for rural Indian schools.\n\nContext: {{ $json.full_context }}\n\nWrite a warm 3-4 sentence executive summary that:\n1. Acknowledges {{ $json.school_name }}'s strengths\n2. Highlights GCM Convent's multi-dimensional advantage\n3. Provides professional yet hopeful assessment\n\nProvide ONLY the summary, no labels.",
              "type": "string"
            }
          ]
        }
      },
      "id": "node-task1",
      "name": "Task 1 Setup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [640, 400]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "task_type",
              "value": "category_insights",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "prompt_text",
              "value": "=Educational analyst task.\n\nContext: {{ $json.full_context }}\n\nProvide exactly 5 insights (one per line):\n1. Teaching Quality ({{ $json.categories[0].our }}% vs {{ $json.categories[0].gcm }}%)\n2. Facilities ({{ $json.categories[1].our }}% vs {{ $json.categories[1].gcm }}%)\n3. Activities ({{ $json.categories[2].our }}% vs {{ $json.categories[2].gcm }}%)\n4. Environment ({{ $json.categories[3].our }}% vs {{ $json.categories[3].gcm }}%)\n5. Student Support ({{ $json.categories[4].our }}% vs {{ $json.categories[4].gcm }}%)\n\nOne sentence each. Start with category name.",
              "type": "string"
            }
          ]
        }
      },
      "id": "node-task2",
      "name": "Task 2 Setup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [640, 600]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "task_type",
              "value": "growth_potential",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "prompt_text",
              "value": "=Inspiring educational consultant.\n\nContext: {{ $json.full_context }}\n\nWrite 2-3 inspiring sentences about transformation at GCM:\n- Emphasize {{ $json.happiness_difference }}% happiness increase\n- Connect to comprehensive development\n- Show lasting impact\n\nMake parents visualize their child thriving.",
              "type": "string"
            }
          ]
        }
      },
      "id": "node-task3",
      "name": "Task 3 Setup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [640, 800]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "task_type",
              "value": "recommendation",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "prompt_text",
              "value": "=Practical education advisor.\n\nFamily: Fees {{ $json.fees }}, Travel {{ $json.travel_time }}, Excitement {{ $json.class_excitement }}/10\n\nProvide 2 sentences:\n1. Why GCM fits their constraints\n2. The {{ $json.total_improvement }}% value gained\n\nBe specific and practical.",
              "type": "string"
            }
          ]
        }
      },
      "id": "node-task4",
      "name": "Task 4 Setup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [640, 1000]
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gemini-2.0-flash-exp",
          "mode": "list",
          "cachedResultName": "Gemini 2.0 Flash Experimental"
        },
        "options": {
          "temperature": 0.7,
          "maxOutputTokens": 500
        }
      },
      "id": "node-ai1",
      "name": "AI Gemini 1",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [840, 400],
      "credentials": {
        "googleAiApi": {
          "id": "YOUR_GOOGLE_AI_CREDENTIAL_ID",
          "name": "Google AI"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gemini-2.0-flash-exp",
          "mode": "list",
          "cachedResultName": "Gemini 2.0 Flash Experimental"
        },
        "options": {
          "temperature": 0.7,
          "maxOutputTokens": 800
        }
      },
      "id": "node-ai2",
      "name": "AI Gemini 2",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [840, 600],
      "credentials": {
        "googleAiApi": {
          "id": "YOUR_GOOGLE_AI_CREDENTIAL_ID",
          "name": "Google AI"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gemini-2.0-flash-exp",
          "mode": "list",
          "cachedResultName": "Gemini 2.0 Flash Experimental"
        },
        "options": {
          "temperature": 0.8,
          "maxOutputTokens": 500
        }
      },
      "id": "node-ai3",
      "name": "AI Gemini 3",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [840, 800],
      "credentials": {
        "googleAiApi": {
          "id": "YOUR_GOOGLE_AI_CREDENTIAL_ID",
          "name": "Google AI"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "model": "google/gemini-2.0-flash-exp:free",
        "options": {
          "baseURL": "https://openrouter.ai/api/v1",
          "temperature": 0.7,
          "maxTokens": 400
        }
      },
      "id": "node-ai4",
      "name": "AI OpenRouter 4",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [840, 1000],
      "credentials": {
        "openAiApi": {
          "id": "YOUR_OPENROUTER_CREDENTIAL_ID",
          "name": "OpenRouter"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition"
      },
      "id": "node-merge",
      "name": "Merge AI Outputs",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [1040, 600]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst originalData = $('Transform Data').first().json;\n\nconst aiInsights = {\n  executive_summary: '',\n  category_insights: [],\n  growth_potential: '',\n  personalized_recommendation: '',\n  generation_method: 'ai',\n  models_used: 0\n};\n\nitems.forEach(item => {\n  const taskType = item.json.task_type;\n  const output = item.json.response || item.json.output || item.json.text || '';\n  \n  if (!output) return;\n  \n  aiInsights.models_used++;\n  \n  switch(taskType) {\n    case 'executive_summary':\n      aiInsights.executive_summary = output.trim();\n      break;\n    case 'category_insights':\n      const insights = output.split('\\n')\n        .filter(line => line.trim().length > 20)\n        .map(line => line.trim())\n        .filter(line => \n          line.match(/^[0-9\\.\\-\\*â€¢]/) || \n          line.includes('Teaching') || \n          line.includes('Facilities') || \n          line.includes('Activities') || \n          line.includes('Environment') || \n          line.includes('Support')\n        );\n      aiInsights.category_insights = insights.slice(0, 5);\n      break;\n    case 'growth_potential':\n      aiInsights.growth_potential = output.trim();\n      break;\n    case 'recommendation':\n      aiInsights.personalized_recommendation = output.trim();\n      break;\n  }\n});\n\nif (!aiInsights.executive_summary) {\n  aiInsights.executive_summary = `${originalData.school_name} shows solid foundations. GCM Convent offers comprehensive excellence across all dimensions - teaching, facilities, activities, environment, and support. Unlike most schools excelling in one area, GCM's multi-dimensional approach creates lasting student success.`;\n  aiInsights.generation_method = 'fallback';\n}\n\nif (!aiInsights.category_insights || aiInsights.category_insights.length < 5) {\n  aiInsights.category_insights = [\n    `Teaching Quality: ${originalData.categories[0].our}% vs ${originalData.categories[0].gcm}% - GCM offers advanced methods and smaller classes.`,\n    `Facilities: ${originalData.categories[1].our}% vs ${originalData.categories[1].gcm}% - GCM provides state-of-the-art labs and infrastructure.`,\n    `Activities: ${originalData.activities_count} activities vs GCM's 12+ options for holistic development.`,\n    `Environment: GCM's ${originalData.categories[3].gcm}% reflects AC classrooms and inspiring spaces.`,\n    `Student Support: ${originalData.categories[4].gcm}% shows personalized mentoring and counseling.`\n  ];\n}\n\nif (!aiInsights.growth_potential) {\n  aiInsights.growth_potential = `At GCM, students experience ${originalData.happiness_difference}% happiness increase. Comprehensive development across academics, activities, and support creates measurable improvements in well-being and success.`;\n}\n\nif (!aiInsights.personalized_recommendation) {\n  aiInsights.personalized_recommendation = `With ${originalData.travel_time} commute and ${originalData.fees} fees, GCM is well-positioned. The ${originalData.total_improvement}% improvement represents meaningful investment in comprehensive education.`;\n}\n\nreturn {\n  ...originalData,\n  ai_insights: aiInsights,\n  processing_status: `Generated using ${aiInsights.models_used} AI models`\n};"
      },
      "id": "node-compile",
      "name": "Compile Insights",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1240, 600]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.ai_insights.generation_method }}",
              "rightValue": "fallback",
              "operator": {
                "type": "string",
                "operation": "notEquals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "node-check",
      "name": "Check AI Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1440, 600]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "c2",
              "leftValue": "={{ $json.retry_count }}",
              "rightValue": "={{ $json.max_retries }}",
              "operator": {
                "type": "number",
                "operation": "smaller"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "id": "node-retry-check",
      "name": "Check Retry Limit",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1640, 800]
    },
    {
      "parameters": {
        "amount": 5,
        "unit": "minutes"
      },
      "id": "node-wait",
      "name": "Wait 5 Minutes",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [1840, 900]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\ndata.retry_count = (data.retry_count || 0) + 1;\ndata.processing_status = `Retry ${data.retry_count}/${data.max_retries}`;\nreturn data;"
      },
      "id": "node-increment",
      "name": "Increment Retry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2040, 900]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "YOUR_SHEET_ID",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Reports",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $json.timestamp }}",
            "School_Name": "={{ $json.school_name }}",
            "Mobile": "={{ $json.mobile_number }}",
            "Our_Score": "={{ $json.our_school_score }}",
            "GCM_Score": "={{ $json.gcm_score }}",
            "Happiness_Diff": "={{ $json.happiness_difference }}",
            "Ranking": "={{ $json.ranking_improvement }}",
            "Total_Improvement": "={{ $json.total_improvement }}",
            "Executive_Summary": "={{ $json.ai_insights.executive_summary }}",
            "Growth_Potential": "={{ $json.ai_insights.growth_potential }}",
            "Recommendation": "={{ $json.ai_insights.personalized_recommendation }}",
            "AI_Method": "={{ $json.ai_insights.generation_method }}",
            "Models_Used": "={{ $json.ai_insights.models_used }}",
            "Retry_Count": "={{ $json.retry_count }}",
            "Status": "Pending PDF"
          }
        }
      },
      "id": "node-sheets",
      "name": "Google Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [1640, 400],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YOUR_SHEETS_CREDENTIAL_ID",
          "name": "Google Sheets"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://script.google.com/macros/s/YOUR_APPS_SCRIPT_ID/exec",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"action\": \"generateReport\", \"data\": $json } }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "node-pdf",
      "name": "Generate PDF",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1840, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://YOUR_EVOLUTION_API/message/sendMedia/YOUR_INSTANCE",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"number\": $('Check AI Success').item.json.mobile_number,\n  \"mediatype\": \"document\",\n  \"mimetype\": \"application/pdf\",\n  \"caption\": \"ðŸŽ‰ School Report Ready!\\n\\nDear \" + $('Check AI Success').item.json.school_name + \" Family,\\n\\nYour GCM comparison is complete! ðŸ“Š\\n\\nðŸ“ˆ Happiness: +\" + $('Check AI Success').item.json.happiness_difference + \"%\\nðŸ† Ranking: #\" + $('Check AI Success').item.json.ranking_improvement + \"\\nðŸ’¯ Improvement: \" + $('Check AI Success').item.json.total_improvement + \"%\\n\\n\" + $('Check AI Success').item.json.ai_insights.executive_summary.substring(0, 150) + \"...\\n\\nðŸ“„ Full PDF attached!\\n\\nðŸ« GCM Convent School\\nðŸ“ž +91-98765-43210\\nðŸŒ www.gcmconvent.edu.in\",\n  \"media\": $json.pdf_url\n} }}"
      },
      "id": "node-whatsapp",
      "name": "Send WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2040, 400],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_EVOLUTION_CREDENTIAL_ID",
          "name": "Evolution API"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"school_name\": $('Check AI Success').item.json.school_name,\n  \"mobile\": $('Check AI Success').item.json.mobile_number,\n  \"pdf_url\": $('Generate PDF').first().json.pdf_url,\n  \"ai_method\": $('Check AI Success').item.json.ai_insights.generation_method,\n  \"models_used\": $('Check AI Success').item.json.ai_insights.models_used,\n  \"retry_count\": $('Check AI Success').item.json.retry_count,\n  \"timestamp\": $('Check AI Success').item.json.timestamp\n} }}"
      },
      "id": "node-response",
      "name": "Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2240, 400]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{"node": "Transform Data", "type": "main", "index": 0}]]
    },
    "Transform Data": {
      "main": [[
        {"node": "Task 1 Setup", "type": "main", "index": 0},
        {"node": "Task 2 Setup", "type": "main", "index": 0},
        {"node": "Task 3 Setup", "type": "main", "index": 0},
        {"node": "Task 4 Setup", "type": "main", "index": 0}
      ]]
    },
    "Task 1 Setup": {
      "main": [[{"node": "AI Gemini 1", "type": "main", "index": 0}]]
    },
    "Task 2 Setup": {
      "main": [[{"node": "AI Gemini 2", "type": "main", "index": 0}]]
    },
    "Task 3 Setup": {
      "main": [[{"node": "AI Gemini 3", "type": "main", "index": 0}]]
    },
    "Task 4 Setup": {
      "main": [[{"node": "AI OpenRouter 4", "type": "main", "index": 0}]]
    },
    "AI Gemini 1": {
      "main": [[{"node": "Merge AI Outputs", "type": "main", "index": 0}]]
    },
    "AI Gemini 2": {
      "main": [[{"node": "Merge AI Outputs", "type": "main", "index": 1}]]
    },
    "AI Gemini 3": {
      "main": [[{"node": "Merge AI Outputs", "type": "main", "index": 2}]]
    },
    "AI OpenRouter 4": {
      "main": [[{"node": "Merge AI Outputs", "type": "main", "index": 3}]]
    },
    "Merge AI Outputs": {
      "main": [[{"node": "Compile Insights", "type": "main", "index": 0}]]
    },
    "Compile Insights": {
      "main": [[{"node": "Check AI Success", "type": "main", "index": 0}]]
    },
    "Check AI Success": {
      "main": [
        [{"node": "Google Sheets", "type": "main", "index": 0}],
        [{"node": "Check Retry Limit", "type": "main", "index": 0}]
      ]
    },
    "Check Retry Limit": {
      "main": [
        [{"node": "Wait 5 Minutes", "type": "main", "index": 0}],
        [{"node": "Google Sheets", "type": "main", "index": 0}]
      ]
    },
    "Wait 5 Minutes": {
      "main": [[{"node": "Increment Retry", "type": "main", "index": 0}]]
    },
    "Increment Retry": {
      "main": [[{"node": "Transform Data", "type": "main", "index": 0}]]
    },
    "Google Sheets": {
      "main": [[{"node": "Generate PDF", "type": "main", "index": 0}]]
    },
    "Generate PDF": {
      "main": [[{"node": "Send WhatsApp", "type": "main", "index": 0}]]
    },
    "Send WhatsApp": {
      "main": [[{"node": "Response", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  }
}
