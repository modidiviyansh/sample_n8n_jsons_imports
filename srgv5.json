{
  "name": "School Report - GCM Convent Dirba Comparison",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "school-report-generate",
        "responseMode": "responseNode"
      },
      "id": "webhook-node",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [240, 600]
    },
    {
      "parameters": {
        "jsCode": "const inputData = $input.item.json;\nconst body = inputData.body || inputData;\n\nconst formResponses = body.form_responses || [];\nconst schoolName = formResponses.find(q => q.question_number === 1)?.response || \"Your Current School\";\nconst fees = formResponses.find(q => q.question_number === 2)?.response_label || \"Not provided\";\nconst travelTime = formResponses.find(q => q.question_number === 3)?.response || \"Not provided\";\nconst activities = formResponses.find(q => q.question_number === 4)?.selected_activities || [];\nconst hasAC = formResponses.find(q => q.question_number === 5)?.response || \"No\";\nconst classExcitement = formResponses.find(q => q.question_number === 6)?.response || 5;\nconst learningEnv = formResponses.find(q => q.question_number === 7)?.response || 5;\n\nconst categories = [\n  { name: \"Teaching Quality\", our: body.our_score1 || 0, gcm: body.other_score1 || 0, difference: (body.our_score1 || 0) - (body.other_score1 || 0) },\n  { name: \"Facilities\", our: body.our_score2 || 0, gcm: body.other_score2 || 0, difference: (body.our_score2 || 0) - (body.other_score2 || 0) },\n  { name: \"Activities\", our: body.our_score3 || 0, gcm: body.other_score3 || 0, difference: (body.our_score3 || 0) - (body.other_score3 || 0) },\n  { name: \"Environment\", our: body.our_score4 || 0, gcm: body.other_score4 || 0, difference: (body.our_score4 || 0) - (body.other_score4 || 0) },\n  { name: \"Student Support\", our: body.our_score5 || 0, gcm: body.other_score5 || 0, difference: (body.our_score5 || 0) - (body.other_score5 || 0) }\n];\n\nconst categoryText = categories.map(c => `${c.name}: Current ${c.our}% vs GCM Dirba ${c.gcm}% (Gap: ${Math.abs(c.difference)}%)`).join('\\n');\n\nreturn {\n  timestamp: new Date().toISOString(),\n  school_name: schoolName,\n  comparison_school: \"GCM Convent School Dirba\",\n  mobile_number: body.mobile_number,\n  our_school_score: body.overall_score_our || 0,\n  gcm_score: body.overall_score_others || 0,\n  score_difference: (body.overall_score_our || 0) - (body.overall_score_others || 0),\n  categories: categories,\n  categories_text: categoryText,\n  happiness_difference: body.happiness_difference || 0,\n  ranking_improvement: body.ranking_difference || 0,\n  total_improvement: body.total_improvement_difference || 0,\n  fees: fees,\n  travel_time: travelTime,\n  activities: activities.join(\", \"),\n  activities_count: activities.length,\n  has_ac: hasAC,\n  class_excitement: classExcitement,\n  learning_environment: learningEnv,\n  form_responses: formResponses,\n  retry_count: body.retry_count || 0,\n  max_retries: 3\n};"
      },
      "id": "transform-node",
      "name": "Transform Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 600]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "task_type",
              "value": "executive_summary",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "ai_prompt",
              "value": "=**CONTEXT: School Comparison Report Generator**\n\nYou are analyzing a school comparison between:\n- **Current School:** {{ $json.school_name }}\n- **Target School:** GCM Convent School Dirba\n\n**PURPOSE:** Generate an empathetic executive summary for a PDF report that parents will receive via WhatsApp.\n\n**COMPARISON DATA:**\nOverall Performance:\n- {{ $json.school_name }}: {{ $json.our_school_score }}%\n- GCM Convent Dirba: {{ $json.gcm_score }}%\n- Gap: {{ Math.abs($json.score_difference) }} percentage points\n\nCategory Breakdown:\n{{ $json.categories_text }}\n\nStudent Happiness Potential: +{{ $json.happiness_difference }}% increase at GCM\nSchool Ranking: #{{ $json.ranking_improvement }}\nTotal Improvement Potential: {{ $json.total_improvement }}%\n\n**YOUR TASK:**\nWrite a warm, empathetic 3-4 sentence executive summary that:\n1. Respectfully acknowledges {{ $json.school_name }}'s current efforts and strengths\n2. Clearly explains GCM Convent School Dirba's comprehensive advantage across ALL 5 dimensions (teaching, facilities, activities, environment, support)\n3. Emphasizes that GCM excels in multiple areas simultaneously (not just one specialty)\n4. Provides hopeful, professional tone suitable for parents making education decisions\n\n**TONE:** Warm, respectful, encouraging, professional\n**AVOID:** Sales language, criticism of current school, generic praise\n**OUTPUT:** Only the summary text, no labels or formatting",
              "type": "string"
            }
          ]
        }
      },
      "id": "task1-node",
      "name": "Task 1 Setup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [640, 340]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "task_type",
              "value": "category_insights",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "ai_prompt",
              "value": "=**CONTEXT: School Comparison Report - Quality Analysis**\n\nYou are providing detailed quality-based category analysis for:\n- **Current School:** {{ $json.school_name }}\n- **Comparison School:** GCM Convent School Dirba\n\n**PURPOSE:** Generate specific, measurable insights for each of 5 comparison categories for PDF report.\n\n**CATEGORY SCORES:**\n\n1. **Teaching Quality**\n   - {{ $json.school_name }}: {{ $json.categories[0].our }}%\n   - GCM Dirba: {{ $json.categories[0].gcm }}%\n   - Gap: {{ Math.abs($json.categories[0].difference) }}%\n\n2. **Facilities & Infrastructure**\n   - {{ $json.school_name }}: {{ $json.categories[1].our }}%\n   - GCM Dirba: {{ $json.categories[1].gcm }}%\n   - Gap: {{ Math.abs($json.categories[1].difference) }}%\n\n3. **Co-curricular Activities**\n   - {{ $json.school_name }}: {{ $json.categories[2].our }}% ({{ $json.activities_count }} activities available)\n   - GCM Dirba: {{ $json.categories[2].gcm }}% (12+ activities including swimming, robotics, performing arts)\n   - Gap: {{ Math.abs($json.categories[2].difference) }}%\n\n4. **Learning Environment**\n   - {{ $json.school_name }}: {{ $json.categories[3].our }}%\n   - GCM Dirba: {{ $json.categories[3].gcm }}% (AC classrooms, modern campus)\n   - Gap: {{ Math.abs($json.categories[3].difference) }}%\n\n5. **Student Support Systems**\n   - {{ $json.school_name }}: {{ $json.categories[4].our }}%\n   - GCM Dirba: {{ $json.categories[4].gcm }}%\n   - Gap: {{ Math.abs($json.categories[4].difference) }}%\n\n**YOUR TASK:**\nProvide exactly 5 quality-focused insights (one per category). Each should:\n- Start with category name\n- Reference specific scores\n- Explain what the gap means in practical terms\n- Be one clear, specific sentence\n- Focus on measurable differences\n\n**FORMAT:**\n1. Teaching Quality: [specific observation about pedagogy, class sizes, teacher qualifications]\n2. Facilities: [specific observation about labs, equipment, infrastructure]\n3. Activities: [specific observation about variety, depth, competitive opportunities]\n4. Environment: [specific observation about campus, classrooms, atmosphere]\n5. Student Support: [specific observation about counseling, mentoring, guidance]\n\n**TONE:** Analytical, specific, constructive, fact-based\n**OUTPUT:** Only the 5 insights, each on new line",
              "type": "string"
            }
          ]
        }
      },
      "id": "task2-node",
      "name": "Task 2 Setup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [640, 540]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "task_type",
              "value": "growth_potential",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "ai_prompt",
              "value": "=**CONTEXT: School Comparison Report - Student Experience & Growth**\n\nYou are crafting an inspiring experience narrative for:\n- **Current School:** {{ $json.school_name }}\n- **Target School:** GCM Convent School Dirba\n\n**PURPOSE:** Paint an emotional, tangible picture of student transformation for parents reading PDF report.\n\n**STUDENT EXPERIENCE DATA:**\n\nCurrent Situation at {{ $json.school_name }}:\n- Student Excitement Level: {{ $json.class_excitement }}/10\n- Learning Environment Rating: {{ $json.learning_environment }}/10\n- Available Activities: {{ $json.activities }}\n- AC Classrooms: {{ $json.has_ac }}\n\nProjected Experience at GCM Convent Dirba:\n- Happiness Increase: +{{ $json.happiness_difference }}% (measurable improvement)\n- School Ranking: #{{ $json.ranking_improvement }} in region\n- Total Experience Improvement: {{ $json.total_improvement }}%\n- 12+ diverse activities (swimming, robotics, theatre, sports, music, arts)\n- Modern AC classrooms with smart boards\n- Professional counseling and mentoring\n- State-of-the-art science labs and library\n\n**YOUR TASK:**\nWrite 2-3 emotionally resonant sentences that:\n1. Make the {{ $json.happiness_difference }}% happiness increase tangible and real for parents\n2. Connect happiness to comprehensive development (not just academics)\n3. Paint a vivid picture of daily student experience at GCM Dirba\n4. Show how multi-dimensional excellence (teaching + facilities + activities + environment + support) creates lasting transformation\n5. Help parents visualize their child thriving, excited, and growing\n\n**TONE:** Inspiring, hopeful, emotionally engaging, tangible, parent-focused\n**AVOID:** Abstract concepts, generic statements, empty promises\n**OUTPUT:** Only the 2-3 sentences describing transformation",
              "type": "string"
            }
          ]
        }
      },
      "id": "task3-node",
      "name": "Task 3 Setup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [640, 740]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1",
              "name": "task_type",
              "value": "recommendation",
              "type": "string"
            },
            {
              "id": "a2",
              "name": "ai_prompt",
              "value": "=**CONTEXT: School Comparison Report - Personalized Family Recommendation**\n\nYou are providing practical, personalized advice for:\n- **Family's Current School:** {{ $json.school_name }}\n- **Considering:** GCM Convent School Dirba\n\n**PURPOSE:** Give specific, actionable recommendation based on this family's unique situation for PDF report.\n\n**THIS FAMILY'S SITUATION:**\n\nPractical Constraints:\n- Monthly Fee Budget: {{ $json.fees }}\n- Daily Commute Time: {{ $json.travel_time }}\n\nCurrent Student Experience:\n- Child's Excitement about Classes: {{ $json.class_excitement }}/10\n- Learning Environment Satisfaction: {{ $json.learning_environment }}/10\n- Current Activities Available: {{ $json.activities || 'Limited options' }}\n\nGCM Convent Dirba Opportunity:\n- Total Improvement Potential: {{ $json.total_improvement }}%\n- Happiness Increase: +{{ $json.happiness_difference }}%\n- School Ranking: #{{ $json.ranking_improvement }}\n- Comprehensive Excellence Score: {{ $json.gcm_score }}% vs Current {{ $json.our_school_score }}%\n\n**YOUR TASK:**\nProvide exactly 2 practical, specific sentences:\n\n**Sentence 1:** Explain how GCM Convent School Dirba specifically fits THIS family's practical constraints (their fee range of {{ $json.fees }} and commute time of {{ $json.travel_time }}). Be concrete about logistics.\n\n**Sentence 2:** Explain the specific, measurable value they'll gain - reference the {{ $json.total_improvement }}% improvement across all dimensions and what that means for their child's daily experience, happiness, and future success.\n\n**TONE:** Practical, specific, confident, advisor-like, trustworthy\n**AVOID:** Generic benefits, vague promises, hard selling\n**OUTPUT:** Only the 2 sentences",
              "type": "string"
            }
          ]
        }
      },
      "id": "task4-node",
      "name": "Task 4 Setup",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [640, 940]
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "modelId": {
          "__rl": true,
          "value": "gemini-2.0-flash-exp",
          "mode": "list"
        },
        "options": {
          "temperature": 0.7,
          "maxOutputTokens": 500
        }
      },
      "id": "ai1-node",
      "name": "AI Gemini 1",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [840, 340],
      "credentials": {
        "googleAiApi": {
          "id": "YOUR_GOOGLE_AI_CREDENTIAL_ID",
          "name": "Google AI"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "modelId": {
          "__rl": true,
          "value": "gemini-2.0-flash-exp",
          "mode": "list"
        },
        "options": {
          "temperature": 0.7,
          "maxOutputTokens": 1000
        }
      },
      "id": "ai2-node",
      "name": "AI Gemini 2",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [840, 540],
      "credentials": {
        "googleAiApi": {
          "id": "YOUR_GOOGLE_AI_CREDENTIAL_ID",
          "name": "Google AI"
        }
      }
    },
    {
      "parameters": {
        "authentication": "serviceAccount",
        "modelId": {
          "__rl": true,
          "value": "gemini-2.0-flash-exp",
          "mode": "list"
        },
        "options": {
          "temperature": 0.8,
          "maxOutputTokens": 600
        }
      },
      "id": "ai3-node",
      "name": "AI Gemini 3",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [840, 740],
      "credentials": {
        "googleAiApi": {
          "id": "YOUR_GOOGLE_AI_CREDENTIAL_ID",
          "name": "Google AI"
        }
      }
    },
    {
      "parameters": {
        "model": "google/gemini-2.0-flash-exp:free",
        "options": {
          "baseURL": "https://openrouter.ai/api/v1",
          "temperature": 0.7,
          "maxTokens": 500
        }
      },
      "id": "ai4-node",
      "name": "AI OpenRouter 4",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [840, 940],
      "credentials": {
        "openAiApi": {
          "id": "YOUR_OPENROUTER_CREDENTIAL_ID",
          "name": "OpenRouter"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// For Gemini Chat Model, output is directly in text format\nconst taskData = $('Task 1 Setup').item.json;\nconst aiResponse = $input.item.json;\n\nlet outputText = '';\n\n// Gemini Chat Model returns text directly or in message format\nif (typeof aiResponse === 'string') {\n  outputText = aiResponse;\n} else if (aiResponse.response) {\n  outputText = aiResponse.response;\n} else if (aiResponse.text) {\n  outputText = aiResponse.text;\n} else if (aiResponse.message && aiResponse.message.content) {\n  outputText = aiResponse.message.content;\n}\n\nreturn {\n  ...taskData,\n  response: outputText.trim(),\n  output: outputText.trim(),\n  text: outputText.trim(),\n  ai_success: outputText.length > 50\n};"
      },
      "id": "extract1-node",
      "name": "Extract AI 1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 340]
    },
    {
      "parameters": {
        "jsCode": "const taskData = $('Task 2 Setup').item.json;\nconst aiResponse = $input.item.json;\n\nlet outputText = '';\n\nif (typeof aiResponse === 'string') {\n  outputText = aiResponse;\n} else if (aiResponse.response) {\n  outputText = aiResponse.response;\n} else if (aiResponse.text) {\n  outputText = aiResponse.text;\n} else if (aiResponse.message && aiResponse.message.content) {\n  outputText = aiResponse.message.content;\n}\n\nreturn {\n  ...taskData,\n  response: outputText.trim(),\n  output: outputText.trim(),\n  text: outputText.trim(),\n  ai_success: outputText.length > 50\n};"
      },
      "id": "extract2-node",
      "name": "Extract AI 2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 540]
    },
    {
      "parameters": {
        "jsCode": "const taskData = $('Task 3 Setup').item.json;\nconst aiResponse = $input.item.json;\n\nlet outputText = '';\n\nif (typeof aiResponse === 'string') {\n  outputText = aiResponse;\n} else if (aiResponse.response) {\n  outputText = aiResponse.response;\n} else if (aiResponse.text) {\n  outputText = aiResponse.text;\n} else if (aiResponse.message && aiResponse.message.content) {\n  outputText = aiResponse.message.content;\n}\n\nreturn {\n  ...taskData,\n  response: outputText.trim(),\n  output: outputText.trim(),\n  text: outputText.trim(),\n  ai_success: outputText.length > 50\n};"
      },
      "id": "extract3-node",
      "name": "Extract AI 3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 740]
    },
    {
      "parameters": {
        "jsCode": "const taskData = $('Task 4 Setup').item.json;\nconst aiResponse = $input.item.json;\n\nlet outputText = '';\n\nif (typeof aiResponse === 'string') {\n  outputText = aiResponse;\n} else if (aiResponse.response) {\n  outputText = aiResponse.response;\n} else if (aiResponse.text) {\n  outputText = aiResponse.text;\n} else if (aiResponse.message && aiResponse.message.content) {\n  outputText = aiResponse.message.content;\n}\n\nreturn {\n  ...taskData,\n  response: outputText.trim(),\n  output: outputText.trim(),\n  text: outputText.trim(),\n  ai_success: outputText.length > 50\n};"
      },
      "id": "extract4-node",
      "name": "Extract AI 4",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 940]
    },
    {
      "parameters": {
        "mode": "combine",
        "combinationMode": "mergeByPosition",
        "options": {}
      },
      "id": "merge-node",
      "name": "Merge AI Outputs",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 2.1,
      "position": [1240, 640]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst originalData = $('Transform Data').first().json;\n\nconst aiInsights = {\n  executive_summary: '',\n  category_insights: [],\n  growth_potential: '',\n  personalized_recommendation: '',\n  generation_method: 'ai',\n  models_used: 0\n};\n\nitems.forEach(item => {\n  const taskType = item.json.task_type;\n  const output = item.json.response || item.json.output || item.json.text || '';\n  const success = item.json.ai_success;\n  \n  if (!output || !success) return;\n  \n  aiInsights.models_used++;\n  \n  switch(taskType) {\n    case 'executive_summary':\n      aiInsights.executive_summary = output.trim();\n      break;\n    case 'category_insights':\n      const insights = output.split('\\n')\n        .filter(line => line.trim().length > 20)\n        .map(line => line.trim())\n        .filter(line => \n          line.match(/^[0-9\\.\\-\\*â€¢]/) || \n          line.toLowerCase().includes('teaching') || \n          line.toLowerCase().includes('facilities') || \n          line.toLowerCase().includes('activit') || \n          line.toLowerCase().includes('environment') || \n          line.toLowerCase().includes('support')\n        );\n      aiInsights.category_insights = insights.slice(0, 5);\n      break;\n    case 'growth_potential':\n      aiInsights.growth_potential = output.trim();\n      break;\n    case 'recommendation':\n      aiInsights.personalized_recommendation = output.trim();\n      break;\n  }\n});\n\n// Fallbacks\nif (!aiInsights.executive_summary) {\n  aiInsights.executive_summary = `${originalData.school_name} has built a solid educational foundation. However, GCM Convent School Dirba offers comprehensive excellence across all five dimensions - teaching quality, modern facilities, diverse activities, inspiring environment, and robust student support. Unlike most schools that specialize in one area, GCM Dirba's multi-dimensional approach creates an ecosystem where students consistently achieve higher happiness levels and academic success.`;\n  aiInsights.generation_method = 'fallback';\n}\n\nif (!aiInsights.category_insights || aiInsights.category_insights.length < 5) {\n  aiInsights.category_insights = [\n    `1. Teaching Quality: With ${originalData.categories[0].our}% vs GCM's ${originalData.categories[0].gcm}%, the ${Math.abs(originalData.categories[0].difference)}% gap reflects GCM Dirba's investment in trained educators, smaller class sizes (max 25 students), and modern pedagogical methods.`,\n    `2. Facilities: The ${Math.abs(originalData.categories[1].difference)}% difference (${originalData.categories[1].our}% vs ${originalData.categories[1].gcm}%) showcases GCM's state-of-the-art science labs, digital classrooms with smart boards, comprehensive library, and modern sports infrastructure.`,\n    `3. Activities: With ${originalData.activities_count} activities currently available vs GCM's 12+ options (including swimming pool, robotics lab, theatre, competitive sports), students gain ${Math.abs(originalData.categories[2].difference)}% more opportunities for holistic development.`,\n    `4. Environment: GCM Dirba's ${originalData.categories[3].gcm}% score reflects fully air-conditioned classrooms, green campus zones, dedicated study areas, and an overall atmosphere designed to inspire daily learning.`,\n    `5. Student Support: The ${Math.abs(originalData.categories[4].difference)}% gap demonstrates GCM's comprehensive support system including professional counselors, personalized academic mentoring, career guidance programs, and dedicated pastoral care.`\n  ];\n}\n\nif (!aiInsights.growth_potential) {\n  aiInsights.growth_potential = `At GCM Convent School Dirba, students experience a remarkable ${originalData.happiness_difference}% increase in daily happiness and school satisfaction. This transformation comes from waking up excited for swimming lessons before school, engaging with robotics projects in state-of-the-art labs, receiving personalized attention in smaller classes, and feeling truly supported by professional counselors who know each student's dreams and challenges. It's not just about better scores - it's about creating an environment where children genuinely love learning and growing every single day.`;\n}\n\nif (!aiInsights.personalized_recommendation) {\n  aiInsights.personalized_recommendation = `Given your family's ${originalData.travel_time} commute time and ${originalData.fees} fee budget, GCM Convent School Dirba is strategically positioned in Dirba to serve your needs while fitting your financial planning. The substantial ${originalData.total_improvement}% improvement potential across all educational dimensions - from teaching excellence to comprehensive student support - represents a meaningful investment that will compound into your child's confidence, capabilities, and future success for years to come.`;\n}\n\nreturn {\n  ...originalData,\n  ai_insights: aiInsights,\n  processing_status: `AI insights generated using ${aiInsights.models_used}/4 models - ${aiInsights.generation_method}`\n};"
      },
      "id": "compile-node",
      "name": "Compile Insights",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1440, 640]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false
          },
          "conditions": [
            {
              "id": "c1",
              "leftValue": "={{ $json.ai_insights.models_used }}",
              "rightValue": 2,
              "operator": {
                "type": "number",
                "operation": "largerEqual"
              }
            }
          ]
        }
      },
      "id": "check-node",
      "name": "Check AI Success",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1640, 640]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "id": "c2",
              "leftValue": "={{ $json.retry_count }}",
              "rightValue": "={{ $json.max_retries }}",
              "operator": {
                "type": "number",
                "operation": "smaller"
              }
            }
          ]
        }
      },
      "id": "retry-node",
      "name": "Check Retry Limit",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1840, 840]
    },
    {
      "parameters": {
        "amount": 2,
        "unit": "minutes"
      },
      "id": "wait-node",
      "name": "Wait 2 Minutes",
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [2040, 940],
      "webhookId": "retry-wait-webhook"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\ndata.retry_count = (data.retry_count || 0) + 1;\ndata.processing_status = `Retry ${data.retry_count}/${data.max_retries}`;\nreturn { body: data };"
      },
      "id": "increment-node",
      "name": "Increment Retry",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2240, 940]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "YOUR_GOOGLE_SHEET_ID",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Reports",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $json.timestamp }}",
            "School_Name": "={{ $json.school_name }}",
            "Mobile": "={{ $json.mobile_number }}",
            "Current_Score": "={{ $json.our_school_score }}",
            "GCM_Score": "={{ $json.gcm_score }}",
            "Happiness_Increase": "={{ $json.happiness_difference }}",
            "Ranking": "={{ $json.ranking_improvement }}",
            "Total_Improvement": "={{ $json.total_improvement }}",
            "Executive_Summary": "={{ $json.ai_insights.executive_summary }}",
            "Category_Insight_1": "={{ $json.ai_insights.category_insights[0] }}",
            "Category_Insight_2": "={{ $json.ai_insights.category_insights[1] }}",
            "Category_Insight_3": "={{ $json.ai_insights.category_insights[2] }}",
            "Category_Insight_4": "={{ $json.ai_insights.category_insights[3] }}",
            "Category_Insight_5": "={{ $json.ai_insights.category_insights[4] }}",
            "Growth_Potential": "={{ $json.ai_insights.growth_potential }}",
            "Recommendation": "={{ $json.ai_insights.personalized_recommendation }}",
            "AI_Method": "={{ $json.ai_insights.generation_method }}",
            "Models_Used": "={{ $json.ai_insights.models_used }}",
            "Retry_Count": "={{ $json.retry_count }}",
            "Status": "Ready for PDF"
          }
        }
      },
      "id": "sheets-node",
      "name": "Log to Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.4,
      "position": [1840, 440],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YOUR_GOOGLE_SHEETS_CREDENTIAL_ID",
          "name": "Google Sheets"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://script.google.com/macros/s/YOUR_APPS_SCRIPT_ID/exec",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"action\": \"generateReport\", \"data\": $json } }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "pdf-node",
      "name": "Generate PDF",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2040, 440]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://YOUR_EVOLUTION_API_URL/message/sendMedia/YOUR_INSTANCE",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"number\": $('Check AI Success').item.json.mobile_number,\n  \"mediatype\": \"document\",\n  \"mimetype\": \"application/pdf\",\n  \"caption\": \"ðŸŽ‰ *Your GCM Convent Dirba Comparison Report*\\n\\nDear \" + $('Check AI Success').item.json.school_name + \" Family,\\n\\nYour detailed school comparison is ready! ðŸ“Š\\n\\nâœ¨ *Key Highlights:*\\nðŸ“ˆ Student Happiness: +\" + $('Check AI Success').item.json.happiness_difference + \"%\\nðŸ† School Ranking: #\" + $('Check AI Success').item.json.ranking_improvement + \"\\nðŸ’¯ Total Improvement: \" + $('Check AI Success').item.json.total_improvement + \"%\\n\\n\" + $('Check AI Success').item.json.ai_insights.executive_summary.substring(0, 180) + \"...\\n\\nðŸ“„ Complete PDF report attached!\\n\\n---\\nðŸ« *GCM Convent School Dirba*\\nWhere Excellence Meets Opportunity\\n\\nðŸ“ž Contact: +91-98765-43210\\nðŸŒ www.gcmconventdirba.edu.in\\nðŸ“§ admissions@gcmconventdirba.edu.in\\nðŸ“ Dirba, Punjab\",\n  \"media\": $json.pdf_url\n} }}"
      },
      "id": "whatsapp-node",
      "name": "Send WhatsApp",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2240, 440],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_EVOLUTION_API_CREDENTIAL_ID",
          "name": "Evolution API"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ {\n  \"success\": true,\n  \"message\": \"School comparison report generated and sent!\",\n  \"school_name\": $('Check AI Success').item.json.school_name,\n  \"comparison_school\": \"GCM Convent School Dirba\",\n  \"mobile_number\": $('Check AI Success').item.json.mobile_number,\n  \"pdf_url\": $('Generate PDF').first().json.pdf_url,\n  \"ai_generation\": {\n    \"method\": $('Check AI Success').item.json.ai_insights.generation_method,\n    \"models_used\": $('Check AI Success').item.json.ai_insights.models_used,\n    \"total_models\": 4\n  },\n  \"metrics\": {\n    \"happiness_improvement\": $('Check AI Success').item.json.happiness_difference + \"%\",\n    \"ranking\": \"#\" + $('Check AI Success').item.json.ranking_improvement,\n    \"total_improvement\": $('Check AI Success').item.json.total_improvement + \"%\",\n    \"current_score\": $('Check AI Success').item.json.our_school_score + \"%\",\n    \"gcm_score\": $('Check AI Success').item.json.gcm_score + \"%\"\n  },\n  \"retry_count\": $('Check AI Success').item.json.retry_count,\n  \"timestamp\": $('Check AI Success').item.json.timestamp\n} }}"
      },
      "id": "response-node",
      "name": "Send Response",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2440, 440]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [[{"node": "Transform Data", "type": "main", "index": 0}]]
    },
    "Transform Data": {
      "main": [[
        {"node": "Task 1 Setup", "type": "main", "index": 0},
        {"node": "Task 2 Setup", "type": "main", "index": 0},
        {"node": "Task 3 Setup", "type": "main", "index": 0},
        {"node": "Task 4 Setup", "type": "main", "index": 0}
      ]]
    },
    "Task 1 Setup": {
      "main": [[{"node": "AI Gemini 1", "type": "main", "index": 0}]]
    },
    "Task 2 Setup": {
      "main": [[{"node": "AI Gemini 2", "type": "main", "index": 0}]]
    },
    "Task 3 Setup": {
      "main": [[{"node": "AI Gemini 3", "type": "main", "index": 0}]]
    },
    "Task 4 Setup": {
      "main": [[{"node": "AI OpenRouter 4", "type": "main", "index": 0}]]
    },
    "AI Gemini 1": {
      "main": [[{"node": "Extract AI 1", "type": "main", "index": 0}]]
    },
    "AI Gemini 2": {
      "main": [[{"node": "Extract AI 2", "type": "main", "index": 0}]]
    },
    "AI Gemini 3": {
      "main": [[{"node": "Extract AI 3", "type": "main", "index": 0}]]
    },
    "AI OpenRouter 4": {
      "main": [[{"node": "Extract AI 4", "type": "main", "index": 0}]]
    },
    "Extract AI 1": {
      "main": [[{"node": "Merge AI Outputs", "type": "main", "index": 0}]]
    },
    "Extract AI 2": {
      "main": [[{"node": "Merge AI Outputs", "type": "main", "index": 1}]]
    },
    "Extract AI 3": {
      "main": [[{"node": "Merge AI Outputs", "type": "main", "index": 2}]]
    },
    "Extract AI 4": {
      "main": [[{"node": "Merge AI Outputs", "type": "main", "index": 3}]]
    },
    "Merge AI Outputs": {
      "main": [[{"node": "Compile Insights", "type": "main", "index": 0}]]
    },
    "Compile Insights": {
      "main": [[{"node": "Check AI Success", "type": "main", "index": 0}]]
    },
    "Check AI Success": {
      "main": [
        [{"node": "Log to Sheets", "type": "main", "index": 0}],
        [{"node": "Check Retry Limit", "type": "main", "index": 0}]
      ]
    },
    "Check Retry Limit": {
      "main": [
        [{"node": "Wait 2 Minutes", "type": "main", "index": 0}],
        [{"node": "Log to Sheets", "type": "main", "index": 0}]
      ]
    },
    "Wait 2 Minutes": {
      "main": [[{"node": "Increment Retry", "type": "main", "index": 0}]]
    },
    "Increment Retry": {
      "main": [[{"node": "Transform Data", "type": "main", "index": 0}]]
    },
    "Log to Sheets": {
      "main": [[{"node": "Generate PDF", "type": "main", "index": 0}]]
    },
    "Generate PDF": {
      "main": [[{"node": "Send WhatsApp", "type": "main", "index": 0}]]
    },
    "Send WhatsApp": {
      "main": [[{"node": "Send Response", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": {},
  "tags": []
}
